{% extends 'base.html' %} {% block content %}
<main class="col-md-12">
  <div
    class="
      d-flex
      justify-content-between
      flex-wrap flex-md-nowrap
      align-items-center
      pt-3
      pb-2
      mb-3
      border-bottom
    "
  >
    <h1 class="h2">Upload</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
      <div class="btn-group me-2"></div>
    </div>
  </div>
  <form class="row g-3 needs-validation" novalidate method="POST">
    {% csrf_token %}
    <div class="col-12">
      <label for="customFile" class="form-label"></label>
      <input type="file" class="form-control" id="customFile" />
    </div>
    <div class="col-12">
      <button
        class="btn btn-primary"
        type="submit"
        value="Submit"
        id="ajax-call"
      >
        Submit
      </button>
    </div>
  </form>
  <hr />
  <h2>Results</h2>
  <div class="table-responsive">
    <table class="table table-striped table-sm" id="table-results">
      <thead>
        <tr>
          <th scope="col">#</th>
          <th scope="col">Image</th>
          <th scope="col">Timestamp</th>
          <th scope="col">Predict</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>1,001</td>
          <td>random</td>
          <td>data</td>
          <td>placeholder</td>
        </tr>
        <tr>
          <td>1,002</td>
          <td>placeholder</td>
          <td>irrelevant</td>
          <td>layout</td>
        </tr>
      </tbody>
    </table>
  </div>
</main>
<script>
  const tbody = document.querySelector("#table-results tbody");
  document.querySelector("#ajax-call").addEventListener("click", (event) => {
    event.preventDefault();
    let formData = new FormData();
    // On récupère la valeur du jeton CSRF
    let csrfTokenValue = document.querySelector(
      "[name=csrfmiddlewaretoken]"
    ).value;
    const request = new Request('{% url "predict:compute" %}', {
      method: "POST",
      body: formData,
      headers: { "X-CSRFToken": csrfTokenValue }, // On ajoute le token dans l'en-tête
    });

    // On exécute la requête
    fetch(request)
      .then((response) => response.json())
      .then((result) => {
        const newRow = tbody.insertRow(0);
        let newCell;
        let newText;

        for (let [key, value] of Object.entries(result)) {
          newCell = newRow.insertCell();
          if (key == "image_url") {
            newCell.innerHTML = `image of ${value}`;
          } else {
            newCell.innerHTML = value;
          }
        }
      });
  });
</script>
{% endblock %}
